name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud (Service Account JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: compassion-course-websit-937d6

      - name: Setup Firebase Authentication
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccountKey.json
          GCP_SA_KEY_JSON: ${{ secrets.GCP_SA_KEY_JSON }}
        run: |
          echo "Setting up Firebase authentication with service account..."
          # Create service account key file from secret
          SERVICE_ACCOUNT_KEY_PATH="${{ github.workspace }}/serviceAccountKey.json"
          # Write JSON using printf to handle special characters properly
          printf '%s\n' "$GCP_SA_KEY_JSON" > "$SERVICE_ACCOUNT_KEY_PATH"
          chmod 600 "$SERVICE_ACCOUNT_KEY_PATH"
          echo "‚úÖ Service account key file created at $SERVICE_ACCOUNT_KEY_PATH"
          # Validate JSON format
          if ! python3 -m json.tool "$SERVICE_ACCOUNT_KEY_PATH" > /dev/null 2>&1; then
            echo "‚ùå ERROR: Service account key JSON is invalid!"
            echo "First 200 chars of file:"
            head -c 200 "$SERVICE_ACCOUNT_KEY_PATH"
            exit 1
          fi
          echo "‚úÖ JSON format validated"
          # Activate service account with gcloud
          gcloud auth activate-service-account --key-file="$SERVICE_ACCOUNT_KEY_PATH"
          # Set application default credentials
          export GOOGLE_APPLICATION_CREDENTIALS="$SERVICE_ACCOUNT_KEY_PATH"
          echo "‚úÖ Service account activated"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"
          # Verify ADC is working
          gcloud auth application-default print-access-token > /dev/null && echo "‚úÖ ADC working" || echo "‚ö†Ô∏è ADC not working"
          # Set Firebase project (without requiring login)
          firebase use compassion-course-websit-937d6 --non-interactive || firebase use --add compassion-course-websit-937d6 --non-interactive

      - name: Check and Enable Required APIs
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccountKey.json
        run: |
          echo "üîß Checking Firebase Storage API status..."
          SERVICE_ACCOUNT_KEY_PATH="${{ github.workspace }}/serviceAccountKey.json"
          # Activate service account
          gcloud auth activate-service-account --key-file="$SERVICE_ACCOUNT_KEY_PATH"
          # Check if API is enabled
          if gcloud services list --enabled --project=compassion-course-websit-937d6 --filter="name:firebasestorage.googleapis.com" --format="value(name)" | grep -q firebasestorage; then
            echo "‚úÖ Firebase Storage API is already enabled"
          else
            echo "‚ö†Ô∏è Firebase Storage API is not enabled"
            echo "Attempting to enable (may fail if service account lacks Service Usage Admin role)..."
            gcloud services enable firebasestorage.googleapis.com --project=compassion-course-websit-937d6 || {
              echo "‚ùå Could not enable API automatically"
              echo "üìù Please enable it manually:"
              echo "   1. Go to https://console.cloud.google.com/apis/library/firebasestorage.googleapis.com?project=compassion-course-websit-937d6"
              echo "   2. Click 'Enable'"
              echo "   OR grant Service Usage Admin role to the service account"
            }
          fi

      - name: Deploy to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccountKey.json
        run: |
          echo "üöÄ Deploying to Firebase..."
          echo "Using service account authentication"
          SERVICE_ACCOUNT_KEY_PATH="${{ github.workspace }}/serviceAccountKey.json"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"
          ls -la "$GOOGLE_APPLICATION_CREDENTIALS" || echo "Service account key file not found!"
          # Verify JSON is still valid
          if ! python3 -m json.tool "$SERVICE_ACCOUNT_KEY_PATH" > /dev/null 2>&1; then
            echo "‚ùå ERROR: Service account key JSON is invalid in deploy step!"
            exit 1
          fi
          # Activate service account
          gcloud auth activate-service-account --key-file="$SERVICE_ACCOUNT_KEY_PATH"
          # Verify authentication
          echo "Current authenticated accounts:"
          gcloud auth list
          # Generate access token from service account
          # Note: Using --token is deprecated but necessary until Firebase CLI fully supports GOOGLE_APPLICATION_CREDENTIALS
          echo "Generating access token for Firebase CLI..."
          FIREBASE_TOKEN=$(gcloud auth print-access-token)
          echo "‚úÖ Access token generated"
          
          # Deploy hosting first (this should always work)
          echo "üì¶ Deploying hosting..."
          firebase deploy --only hosting --project compassion-course-websit-937d6 --non-interactive --token "$FIREBASE_TOKEN"
          echo "‚úÖ Hosting deployed successfully"
          
          # Deploy storage separately (may fail if API not enabled)
          echo "üì¶ Deploying storage rules..."
          if firebase deploy --only storage --project compassion-course-websit-937d6 --non-interactive --token "$FIREBASE_TOKEN"; then
            echo "‚úÖ Storage rules deployed successfully"
          else
            echo "‚ö†Ô∏è Storage deployment failed (likely due to Firebase Storage API not enabled)"
            echo "üìù To fix this, enable the Firebase Storage API:"
            echo "   https://console.cloud.google.com/apis/library/firebasestorage.googleapis.com?project=compassion-course-websit-937d6"
            echo "   OR grant 'Service Usage Admin' role to the service account"
            echo "‚úÖ Hosting deployment was successful, continuing..."
          fi
