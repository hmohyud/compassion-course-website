rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Single authoritative admin signal: admins/{uid} document exists
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    // Helper function to check if user owns a resource
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // WEBSITE CONTENT (Public read, Admin write)
    // ============================================
    
    // Content collection - readable by all, writable by admins
    match /content/{contentId} {
      allow read: if true; // Public read access
      allow write: if isAdmin();
    }
    
    // Config (e.g. memberHub links) - authenticated read, admin write
    match /config/{configId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Team members - readable by all, writable by admins
    match /teamMembers/{memberId} {
      allow read: if true; // Public read access
      allow write: if isAdmin();
    }
    
    // Language sections - readable by all, writable by admins
    match /teamLanguageSections/{sectionId} {
      allow read: if true; // Public read access
      allow write: if isAdmin();
    }
    
    // Board members collection
    match /boardMembers/{memberId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Programs collection
    match /programs/{programId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Events collection
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // ADMIN MANAGEMENT
    // ============================================
    
    // Admins collection - authority is admins/{uid}; bootstrap: user can create own doc once
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow create: if request.auth != null && adminId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // USER PROFILES (userProfiles) - owner read/write own; admin list/read/update all
    // ============================================
    match /userProfiles/{userId} {
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow list: if request.auth != null && isAdmin();
      allow create, update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if false;
    }
    
    // ============================================
    // ORGANIZATIONS (Members can read, owners/admins can write)
    // ============================================
    
    match /organizations/{orgId} {
      allow read: if request.auth != null; // Authenticated users can read
      allow write: if isAdmin(); // Only admins can create/update/delete for now
      // TODO: Add owner-based write rules when organization ownership is implemented
    }
    
    // ============================================
    // WEBCASTS (Public read, Admin/Org owner write)
    // ============================================
    
    match /webcasts/{webcastId} {
      allow read: if true; // Public read access
      allow write: if isAdmin(); // Only admins can create/update/delete for now
      // TODO: Add org owner write rules when implemented
    }
    
    match /webcastSessions/{sessionId} {
      allow read: if request.auth != null; // Authenticated users can read their sessions
      allow create: if request.auth != null; // Users can create their own sessions
      allow update: if request.auth != null; // Users can update their own sessions
      allow delete: if isAdmin(); // Only admins can delete
    }
    
    // ============================================
    // COURSES & LEARNING (Authenticated users)
    // ============================================
    
    match /courses/{courseId} {
      allow read: if request.auth != null; // Authenticated users can read
      allow write: if isAdmin(); // Only admins can create/update/delete
    }
    
    match /modules/{moduleId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /lessons/{lessonId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /enrollments/{enrollmentId} {
      allow read: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // ============================================
    // COMMUNITY & SOCIAL (Authenticated users)
    // ============================================
    
    match /communities/{communityId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(); // Only admins for now
      // TODO: Add owner-based write rules
    }
    
    match /spaces/{spaceId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
    }
    
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
    }
    
    match /memberships/{membershipId} {
      allow read: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if isAdmin();
      allow delete: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
    }
    
    // ============================================
    // CHAT & MESSAGING (Authenticated users)
    // ============================================
    
    match /chats/{chatId} {
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.participants || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.participants || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    match /messages/{messageId} {
      allow read: if request.auth != null; // Users can read messages in chats they're part of
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.senderId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.senderId) || isAdmin()
      );
    }

    // ============================================
    // LEADERSHIP PORTAL (Dashboard, Teams, Work items)
    // ============================================
    // Access controlled by app (LeadershipProtectedRoute); any authenticated user may read/write.
    match /leadershipMessages/{id} {
      allow read, write: if request.auth != null;
    }
    match /teams/{id} {
      allow read, write: if request.auth != null;
    }
    match /workItems/{id} {
      allow read, write: if request.auth != null;
    }
    match /boards/{id} {
      allow read, write: if request.auth != null;
    }
    match /teamBoardSettings/{id} {
      allow read, write: if request.auth != null;
    }
    // Working agreements: doc id = teamId; allow if user is in team or admin
    match /leadershipWorkingAgreements/{teamId} {
      allow read, write: if request.auth != null && (
        request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.memberIds
        || isAdmin()
      );
    }
  }
}
