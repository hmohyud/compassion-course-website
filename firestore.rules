rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }
    function isSignedIn() {
      return request.auth != null;
    }
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }
    function roleOf(uid) {
      return userDoc(uid).data.role;
    }
    function statusOf(uid) {
      return userDoc(uid).data.status;
    }
    function isActiveUser() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && statusOf(request.auth.uid) == 'active';
    }
    function isAdmin() {
      return signedIn()
        && (
          (exists(/databases/$(database)/documents/users/$(request.auth.uid))
            && roleOf(request.auth.uid) == 'admin'
            && statusOf(request.auth.uid) == 'active')
          || exists(/databases/$(database)/documents/admins/$(request.auth.uid))
          || (request.auth.token.email != null && request.auth.token.email.matches('.*@compassioncf\\.com$'))
        );
    }
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ============================================
    // WEBSITE CONTENT (Public read, Admin write)
    // ============================================
    
    // Content collection - readable by all, writable by admins
    match /content/{contentId} {
      allow read: if true; // Public read access
      allow write: if isAdmin();
    }
    
    // Config (e.g. memberHub links) - authenticated read, admin write
    match /config/{configId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    // Team members - readable by all, writable by admins
    match /teamMembers/{memberId} {
      allow read: if true; // Public read access
      allow write: if isAdmin();
    }
    
    // Language sections - readable by all, writable by admins
    match /teamLanguageSections/{sectionId} {
      allow read: if true; // Public read access
      allow write: if isAdmin();
    }
    
    // Board members collection
    match /boardMembers/{memberId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Programs collection
    match /programs/{programId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Events collection
    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ============================================
    // ADMIN MANAGEMENT
    // ============================================
    
    // Admins collection - authority is admins/{uid}; bootstrap: user can create own doc once
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow create: if request.auth != null && adminId == request.auth.uid;
      allow update, delete: if isAdmin();
    }
    
    // ============================================
    // USERS (users/{uid}) - single source of truth for role/status; gate portal access
    // ============================================
    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if signedIn() && request.auth.uid == uid;
      allow update: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow delete: if isAdmin();
    }

    // ============================================
    // USER PROFILES (userProfiles) - owner read/write own; admin list/read/update all
    // ============================================
    match /userProfiles/{userId} {
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow list: if request.auth != null && isAdmin();
      allow create, update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow delete: if false;
    }
    
    // ============================================
    // ORGANIZATIONS (Members can read, owners/admins can write)
    // ============================================
    
    match /organizations/{orgId} {
      allow read: if request.auth != null; // Authenticated users can read
      allow write: if isAdmin(); // Only admins can create/update/delete for now
      // TODO: Add owner-based write rules when organization ownership is implemented
    }
    
    // ============================================
    // WEBCASTS (Public read, Admin/Org owner write)
    // ============================================
    
    match /webcasts/{webcastId} {
      allow read: if true; // Public read access
      allow write: if isAdmin(); // Only admins can create/update/delete for now
      // TODO: Add org owner write rules when implemented
    }
    
    match /webcastSessions/{sessionId} {
      allow read: if request.auth != null; // Authenticated users can read their sessions
      allow create: if request.auth != null; // Users can create their own sessions
      allow update: if request.auth != null; // Users can update their own sessions
      allow delete: if isAdmin(); // Only admins can delete
    }
    
    // ============================================
    // COURSES & LEARNING (Authenticated users)
    // ============================================
    
    match /courses/{courseId} {
      allow read: if request.auth != null; // Authenticated users can read
      allow write: if isAdmin(); // Only admins can create/update/delete
    }
    
    match /modules/{moduleId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /lessons/{lessonId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /enrollments/{enrollmentId} {
      allow read: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    // ============================================
    // COMMUNITY & SOCIAL (Authenticated users)
    // ============================================
    
    match /communities/{communityId} {
      allow read: if request.auth != null;
      allow write: if isAdmin(); // Only admins for now
      // TODO: Add owner-based write rules
    }
    
    match /spaces/{spaceId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }
    
    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
    }
    
    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
    }
    
    match /memberships/{membershipId} {
      allow read: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if isAdmin();
      allow delete: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
    }
    
    // ============================================
    // CHAT & MESSAGING (Authenticated users)
    // ============================================
    
    match /chats/{chatId} {
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.participants || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.participants || isAdmin()
      );
      allow delete: if isAdmin();
    }
    
    match /messages/{messageId} {
      allow read: if request.auth != null; // Users can read messages in chats they're part of
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.senderId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.senderId) || isAdmin()
      );
    }
    
    // ============================================
    // WHITEBOARDS (site-scoped: authenticated read, admin write only)
    // ============================================
    match /whiteboards/{boardId} {
      allow get, list: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // LEADERSHIP PORTAL (Dashboard, Teams, Work items) â€” admin only
    // ============================================
    // Dashboard data: admins full access; leaders read teams they belong to and related work items
    match /leadershipMessages/{id} {
      allow read, write: if isAdmin();
    }
    match /boards/{id} {
      allow read: if isAdmin() || isActiveUser();
      allow write: if isAdmin();
    }
    match /teams/{id} {
      allow read: if isAdmin() || (isActiveUser() && request.auth.uid in resource.data.get('memberIds', []));
      allow write: if isAdmin();
    }
    match /workItems/{id} {
      allow read: if isAdmin()
        || (isActiveUser() && request.auth.uid == resource.data.get('assigneeId', ''))
        || (isActiveUser() && resource.data.get('teamId', '') != '' && request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('memberIds', []));
      allow write: if isAdmin();
    }
    match /teamBoardSettings/{id} {
      allow read: if isAdmin() || isActiveUser();
      allow write: if isAdmin();
    }
    match /leadershipWorkingAgreements/{teamId} {
      allow read: if isAdmin() || isActiveUser();
      allow write: if isAdmin();
    }
    // User notifications: active user reads own; admins can read all; pending users denied
    match /userNotifications/{notifId} {
      allow read: if isAdmin() || (isActiveUser() && resource.data.userId == request.auth.uid);
      allow create: if isActiveUser() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isActiveUser() && resource.data.userId == request.auth.uid);
      allow delete: if false;
    }
  }
}
