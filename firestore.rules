rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() {
      return request.auth != null;
    }
    function userDoc(uid) {
      return get(/databases/$(database)/documents/users/$(uid));
    }
    function roleOf(uid) {
      return userDoc(uid).data.role;
    }
    function statusOf(uid) {
      return userDoc(uid).data.status;
    }
    function isActive() {
      return signedIn()
        && exists(/databases/$(database)/documents/users/$(request.auth.uid))
        && statusOf(request.auth.uid) == 'active';
    }
    function isActiveUser() {
      return isActive();
    }
    function canWrite() {
      return isActive()
        && (roleOf(request.auth.uid) == 'contributor'
            || roleOf(request.auth.uid) == 'manager'
            || roleOf(request.auth.uid) == 'admin');
    }
    // Admin check: requires admins/{uid} doc with valid role AND active status.
    // This is the ONLY admin gate used throughout these rules.
    function isAdmin() {
      return signedIn()
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role in ['admin', 'superAdmin']
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.status in ['active', 'approved'];
    }
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    function isSelf(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    // Helper: check if user is a member of a team
    function isTeamMember(teamId) {
      return isActive()
        && exists(/databases/$(database)/documents/teams/$(teamId))
        && request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('memberIds', []);
    }

    // ============================================
    // WEBSITE CONTENT (Public read, Admin write)
    // ============================================

    match /content/{contentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /config/{configId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /teamMembers/{memberId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /teamLanguageSections/{sectionId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /boardMembers/{memberId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /programs/{programId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /events/{eventId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ============================================
    // ADMIN MANAGEMENT
    // ============================================

    // Admins collection - UID-keyed; self-read or admin-list; admin can manage other admins
    match /admins/{uid} {
      allow get: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow list: if isAdmin();
      // Admins can grant/revoke admin rights (but not self-revoke is enforced in client code)
      allow create, update: if isAdmin();
      allow delete: if isAdmin() && request.auth.uid != uid;
    }

    // ============================================
    // USERS (users/{uid}) - single source of truth for role/status
    // CRITICAL: Users can only update safe fields on their own doc.
    // Role and status changes must go through Cloud Functions.
    // ============================================
    match /users/{uid} {
      allow read: if signedIn() && (request.auth.uid == uid || isAdmin());
      allow create: if signedIn() && request.auth.uid == uid
        && request.resource.data.role in ['public', 'viewer']
        && request.resource.data.status == 'active';
      allow update: if signedIn() && (
        // Admins can update any field
        isAdmin()
        // Users can only update safe profile fields — NOT role or status
        || (request.auth.uid == uid
            && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'status']))
      );
      allow delete: if isAdmin();
    }

    // ============================================
    // USER PROFILES (userProfiles) - owner read/write own; admin list/read/update all
    // CRITICAL: Users can update their own profile BUT NOT the 'role' field.
    // Role changes must go through Cloud Functions or admin panel.
    // ============================================
    match /userProfiles/{userId} {
      allow get: if request.auth != null && (request.auth.uid == userId || isAdmin());
      allow list: if request.auth != null && isAdmin();
      allow create: if request.auth != null && (
        isAdmin()
        || (request.auth.uid == userId
            && request.resource.data.role == 'viewer')
      );
      allow update: if request.auth != null && (
        isAdmin()
        || (request.auth.uid == userId
            && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
      );
      allow delete: if isAdmin();
    }

    // ============================================
    // ORGANIZATIONS
    // ============================================
    match /organizations/{orgId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ============================================
    // WEBCASTS
    // ============================================
    match /webcasts/{webcastId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Webcast sessions — users can only read/modify their own sessions
    match /webcastSessions/{sessionId} {
      allow read: if signedIn() && (isOwner(resource.data.userId) || isAdmin());
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update: if signedIn() && (isOwner(resource.data.userId) || isAdmin());
      allow delete: if isAdmin();
    }

    // ============================================
    // COURSES & LEARNING
    // ============================================
    match /courses/{courseId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /modules/{moduleId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /lessons/{lessonId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // Enrollments — users can only create enrollments for themselves
    match /enrollments/{enrollmentId} {
      allow read: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow create: if request.auth != null
        && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow delete: if isAdmin();
    }

    // ============================================
    // COMMUNITY & SOCIAL
    // ============================================
    match /communities/{communityId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /spaces/{spaceId} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    match /posts/{postId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
    }

    match /comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
      allow delete: if request.auth != null && (
        isOwner(resource.data.authorId) || isAdmin()
      );
    }

    match /memberships/{membershipId} {
      allow read: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if isAdmin();
      allow delete: if request.auth != null && (
        isOwner(resource.data.userId) || isAdmin()
      );
    }

    // ============================================
    // CHAT & MESSAGING — users can only read messages in their chats
    // ============================================
    match /chats/{chatId} {
      allow read: if request.auth != null && (
        request.auth.uid in resource.data.participants || isAdmin()
      );
      allow create: if request.auth != null;
      allow update: if request.auth != null && (
        request.auth.uid in resource.data.participants || isAdmin()
      );
      allow delete: if isAdmin();
    }

    // Messages — must belong to a chat the user participates in
    match /messages/{messageId} {
      allow read: if signedIn() && (
        isAdmin()
        || (resource.data.chatId != null
            && exists(/databases/$(database)/documents/chats/$(resource.data.chatId))
            && request.auth.uid in get(/databases/$(database)/documents/chats/$(resource.data.chatId)).data.participants)
      );
      allow create: if signedIn();
      allow update: if signedIn() && (
        isOwner(resource.data.senderId) || isAdmin()
      );
      allow delete: if signedIn() && (
        isOwner(resource.data.senderId) || isAdmin()
      );
    }

    // ============================================
    // WHITEBOARDS
    // ============================================
    match /whiteboards/{boardId} {
      allow get, list: if request.auth != null;
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // LEADERSHIP PORTAL — teams, boards, work items
    // ============================================
    match /leadershipMessages/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    // Boards — team members can read their team's board
    match /boards/{id} {
      allow read: if isAdmin()
        || (isActiveUser() && resource.data.get('teamId', '') != ''
            && request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('memberIds', []));
      allow create, update, delete: if isAdmin();
    }
    match /teams/{id} {
      allow read: if isAdmin()
        || (isActiveUser() && request.auth.uid in resource.data.get('memberIds', []));
      allow create, update, delete: if isAdmin();
    }
    match /workItems/{id} {
      allow read: if isAdmin()
        || (isActiveUser() && request.auth.uid == resource.data.get('assigneeId', ''))
        || (isActiveUser() && resource.data.get('teamId', '') != '' && request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('memberIds', []));
      // Write: admin always; contributors/managers only for items in their team
      allow create: if isAdmin()
        || (canWrite() && request.resource.data.get('teamId', '') != ''
            && request.auth.uid in get(/databases/$(database)/documents/teams/$(request.resource.data.teamId)).data.get('memberIds', []));
      allow update: if isAdmin()
        || (canWrite() && resource.data.get('teamId', '') != ''
            && request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('memberIds', []));
      allow delete: if isAdmin()
        || (canWrite() && resource.data.get('teamId', '') != ''
            && request.auth.uid in get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.get('memberIds', []));
    }
    // Team board settings — team members or admins only (scoped to team)
    match /teamBoardSettings/{teamId} {
      allow read: if isAdmin()
        || (canWrite() && request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('memberIds', []));
      allow write: if isAdmin()
        || (canWrite() && request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('memberIds', []));
    }
    // Leadership working agreements — team members or admins only (scoped to team)
    match /leadershipWorkingAgreements/{teamId} {
      allow read: if isAdmin()
        || (canWrite() && request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('memberIds', []));
      allow write: if isAdmin()
        || (canWrite() && request.auth.uid in get(/databases/$(database)/documents/teams/$(teamId)).data.get('memberIds', []));
    }
    // User notifications: active user reads/updates own; any contributor+ can create
    match /userNotifications/{notifId} {
      allow read: if isAdmin() || (isActiveUser() && resource.data.userId == request.auth.uid);
      allow create: if isAdmin() || canWrite();
      allow update: if isAdmin() || (isActiveUser() && resource.data.userId == request.auth.uid);
      allow delete: if false;
    }
  }
}
