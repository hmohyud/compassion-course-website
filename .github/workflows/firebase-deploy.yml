name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_PROJECT_ID: ${{ secrets.VITE_FIREBASE_PROJECT_ID }}
          VITE_FIREBASE_STORAGE_BUCKET: ${{ secrets.VITE_FIREBASE_STORAGE_BUCKET }}
          VITE_FIREBASE_MESSAGING_SENDER_ID: ${{ secrets.VITE_FIREBASE_MESSAGING_SENDER_ID }}
          VITE_FIREBASE_APP_ID: ${{ secrets.VITE_FIREBASE_APP_ID }}
          VITE_FIREBASE_MEASUREMENT_ID: ${{ secrets.VITE_FIREBASE_MEASUREMENT_ID }}

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Authenticate to Google Cloud (Service Account JSON)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY_JSON }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: compassion-course-websit-937d6

      - name: Setup Firebase Authentication
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccountKey.json
        run: |
          echo "Setting up Firebase authentication with service account..."
          # Create service account key file from secret
          SERVICE_ACCOUNT_KEY_PATH="${{ github.workspace }}/serviceAccountKey.json"
          echo "${{ secrets.GCP_SA_KEY_JSON }}" > "$SERVICE_ACCOUNT_KEY_PATH"
          chmod 600 "$SERVICE_ACCOUNT_KEY_PATH"
          echo "‚úÖ Service account key file created at $SERVICE_ACCOUNT_KEY_PATH"
          # Activate service account with gcloud
          gcloud auth activate-service-account --key-file="$SERVICE_ACCOUNT_KEY_PATH"
          # Set application default credentials
          export GOOGLE_APPLICATION_CREDENTIALS="$SERVICE_ACCOUNT_KEY_PATH"
          echo "‚úÖ Service account activated"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"
          # Verify ADC is working
          gcloud auth application-default print-access-token > /dev/null && echo "‚úÖ ADC working" || echo "‚ö†Ô∏è ADC not working"
          # Set Firebase project (without requiring login)
          firebase use compassion-course-websit-937d6 --non-interactive || firebase use --add compassion-course-websit-937d6 --non-interactive

      - name: Deploy to Firebase
        env:
          GOOGLE_APPLICATION_CREDENTIALS: ${{ github.workspace }}/serviceAccountKey.json
        run: |
          echo "üöÄ Deploying to Firebase..."
          echo "Using service account authentication"
          SERVICE_ACCOUNT_KEY_PATH="${{ github.workspace }}/serviceAccountKey.json"
          echo "GOOGLE_APPLICATION_CREDENTIALS=$GOOGLE_APPLICATION_CREDENTIALS"
          ls -la "$GOOGLE_APPLICATION_CREDENTIALS" || echo "Service account key file not found!"
          # Activate service account
          gcloud auth activate-service-account --key-file="$SERVICE_ACCOUNT_KEY_PATH"
          # Verify authentication
          echo "Current authenticated accounts:"
          gcloud auth list
          # Generate access token from service account
          # Note: Using --token is deprecated but necessary until Firebase CLI fully supports GOOGLE_APPLICATION_CREDENTIALS
          echo "Generating access token for Firebase CLI..."
          FIREBASE_TOKEN=$(gcloud auth print-access-token)
          echo "‚úÖ Access token generated"
          # Deploy using Firebase CLI
          # Using --token as workaround: Firebase CLI doesn't reliably use GOOGLE_APPLICATION_CREDENTIALS yet
          firebase deploy --only hosting,storage --project compassion-course-websit-937d6 --non-interactive --token "$FIREBASE_TOKEN"
