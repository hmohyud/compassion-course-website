rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             firestore.exists(/databases/(default)/documents/admins/$(request.auth.uid));
    }

    // Team member photos - readable by all, writable by admins
    // Max 5MB, images only (including SVG for generated avatars)
    match /team-photos/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null && isAdmin()
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/(jpeg|png|webp|gif|svg\\+xml)');
    }

    // User avatar photos - readable by all, writable by the owning user only
    // Max 5MB, safe image types only (no SVG)
    match /user-avatars/{userId}/{fileName} {
      allow read: if true;
      allow write: if request.auth != null && request.auth.uid == userId
        && request.resource.size < 5 * 1024 * 1024
        && request.resource.contentType.matches('image/(jpeg|png|webp|gif)');
    }

    // Whiteboard files - authenticated users, max 10MB
    // Restrict to images and JSON (Excalidraw scene data)
    match /whiteboards/{boardId}/files/{fileId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null
        && request.resource.size < 10 * 1024 * 1024
        && (request.resource.contentType.matches('image/(jpeg|png|webp|gif|svg\\+xml)')
            || request.resource.contentType == 'application/json');
    }

    // Default: deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
